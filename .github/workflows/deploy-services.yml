name: Deploy Services

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
  schedule:
    - cron: "0 0 * * *"

env:
  CARGO_TERM_COLOR: always

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          targets: x86_64-unknown-linux-musl

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/145756646168/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider"
          service_account: "github-actions-sa@braided-case-416903.iam.gserviceaccount.com"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Login to Artifact Registry
        run: gcloud auth configure-docker us-east1-docker.pkg.dev

      - name: Determine Environment
        id: env
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ENV=pr" >> "$GITHUB_ENV"
            echo "TAG=pr-${{ github.event.pull_request.number }}" >> "$GITHUB_ENV"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "ENV=nightly" >> "$GITHUB_ENV"
            echo "TAG=nightly-$(date +%Y%m%d)" >> "$GITHUB_ENV"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "ENV=prod" >> "$GITHUB_ENV"
            echo "TAG=${{ github.ref_name }}" >> "$GITHUB_ENV"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            BASE="${{ github.event.before }}"
            if [[ -z "$BASE" || "$BASE" == "0000000000000000000000000000000000000000" ]]; then
              BASE="$(git rev-parse HEAD^ 2>/dev/null || echo "$GITHUB_SHA")"
            fi

            echo "ENV=test" >> "$GITHUB_ENV"
            echo "TAG=main-${{ github.sha }}" >> "$GITHUB_ENV"

            if git diff --name-only "$BASE" HEAD -- services/Cargo.toml | grep -q .; then
              VERSION="$(python - <<'PY'
import datetime
import re
import sys
import tomllib
from pathlib import Path

data = tomllib.loads(Path("services/Cargo.toml").read_text())
try:
    version = data["package"]["version"]
except KeyError as exc:
    raise SystemExit(f"Service Cargo.toml missing package.version: {exc}")

if not re.fullmatch(r"\d{4}\.\d{2}\.\d{2}\+[1-9]\d{0,1}", version):
    sys.exit(f"Service version \"{version}\" does not match required format YYYY.MM.DD+N")

date_part = version.split("+", 1)[0]
try:
    datetime.datetime.strptime(date_part, "%Y.%m.%d")
except ValueError as exc:
    sys.exit(f"Service version date component \"{date_part}\" is not a valid calendar date: {exc}")

print(version)
PY
)"
              echo "ENV=prod" >> "$GITHUB_ENV"
              echo "TAG=$VERSION" >> "$GITHUB_ENV"
            fi
          fi

      - name: Build and Push Docker Image
        run: |
          just docker-push ${{ env.TAG }}

      - name: Deploy to Cloud Run
        run: |
          just services::gcloud-deploy ${{ env.ENV }} ${{ env.TAG }}
