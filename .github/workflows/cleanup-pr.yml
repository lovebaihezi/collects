name: Cleanup PR Environment

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    name: Cleanup PR Resources
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Scripts Dependencies
        working-directory: scripts
        run: bun install --frozen-lockfile

      - name: Install Pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Install UI Dependencies
        working-directory: ui
        run: pnpm install --frozen-lockfile

      - name: Delete WASM from R2
        id: delete-wasm
        working-directory: scripts
        run: |
          if bun run main.ts r2-wasm-delete ${{ github.event.pull_request.number }}; then
            echo "wasm_deleted=true" >> $GITHUB_OUTPUT
          else
            echo "wasm_deleted=false" >> $GITHUB_OUTPUT
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/145756646168/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider"
          service_account: "github-actions-sa@braided-case-416903.iam.gserviceaccount.com"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Delete Docker Image
        id: delete-image
        run: |
          set -x
          
          GCP_REGION="us-east1"
          PROJECT_ID=$(gcloud config get-value project)
          REPOSITORY_NAME="collects-services"
          IMAGE_NAME="collects-services"
          TAG="pr-${{ github.event.pull_request.number }}"
          
          # Try to delete the Docker image tag
          if gcloud artifacts docker images delete \
            "${GCP_REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY_NAME}/${IMAGE_NAME}:${TAG}" \
            --quiet \
            --delete-tags 2>/dev/null; then
            echo "Successfully deleted Docker image with tag: ${TAG}"
            echo "image_deleted=true" >> $GITHUB_OUTPUT
          else
            echo "Docker image with tag ${TAG} not found or already deleted"
            echo "image_deleted=false" >> $GITHUB_OUTPUT
          fi

      - name: Cleanup Summary
        run: |
          echo "## Cleanup Summary for PR #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.delete-wasm.outputs.wasm_deleted }}" == "true" ]]; then
            echo "- ✅ R2 WASM files \`pr-${{ github.event.pull_request.number }}\` deleted" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ℹ️ R2 WASM files \`pr-${{ github.event.pull_request.number }}\` not found or already deleted" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ steps.delete-image.outputs.image_deleted }}" == "true" ]]; then
            echo "- ✅ Docker image \`pr-${{ github.event.pull_request.number }}\` deleted" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ℹ️ Docker image \`pr-${{ github.event.pull_request.number }}\` not found or already deleted" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ℹ️ Cloud Run service \`collects-services-pr\` is shared and remains active" >> $GITHUB_STEP_SUMMARY
          echo "- ℹ️ Cloudflare Worker \`pr\` environment is shared and remains active" >> $GITHUB_STEP_SUMMARY
