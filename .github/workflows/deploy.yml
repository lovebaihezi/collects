name: Deploy Worker

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
  schedule:
    - cron: "0 0 * * *"

env:
  CARGO_TERM_COLOR: always

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libxkbcommon-dev libssl-dev libgtk-3-dev libwayland-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          targets: wasm32-unknown-unknown

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Install Pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Determine Environment
        id: env
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ENV=pr" >> "$GITHUB_ENV"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "ENV=nightly" >> "$GITHUB_ENV"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "ENV=prod" >> "$GITHUB_ENV"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            BASE="${{ github.event.before }}"
            if [[ -z "$BASE" || "$BASE" == "0000000000000000000000000000000000000000" ]]; then
              BASE="$(git rev-parse HEAD^ 2>/dev/null || echo "$GITHUB_SHA")"
            fi

            echo "ENV=test" >> "$GITHUB_ENV"

            if git diff --name-only "$BASE" HEAD -- ui/Cargo.toml | grep -q .; then
              VERSION="$(python - <<'PY'
import datetime
import re
import sys
import tomllib
from pathlib import Path

version = tomllib.loads(Path("ui/Cargo.toml").read_text())["package"]["version"]
if not re.fullmatch(r"\d{4}\.\d{2}\.\d{2}\+[1-9]\d*", version):
    sys.exit(f"UI version \"{version}\" does not match required format YYYY.MM.DD+N")

date_part = version.split("+", 1)[0]
try:
    datetime.datetime.strptime(date_part, "%Y.%m.%d")
except ValueError as exc:
    sys.exit(f"UI version date component \"{date_part}\" is not a valid calendar date: {exc}")

print(version)
PY
)"
              echo "ENV=prod" >> "$GITHUB_ENV"
              echo "UI_VERSION=$VERSION" >> "$GITHUB_ENV"
            fi
          fi

      - name: Deploy Worker
        run: just ui::wk-deploy ${{ env.ENV }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
